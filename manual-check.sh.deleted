#!/bin/bash

echo "ðŸ” Worker URL æ‰‹å‹•ç¢ºèªã‚¹ã‚¯ãƒªãƒ—ãƒˆ"
echo "=========================="

echo ""
echo "ðŸ“‹ 1. ç¾åœ¨ã®Workerä¸€è¦§:"
npx wrangler list

echo ""
echo "ðŸ“‹ 2. ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±:"
npx wrangler whoami

echo ""
echo "ðŸ“‹ 3. component-api Workerã®è©³ç´°æƒ…å ±:"
npx wrangler list | grep -i component

echo ""
echo "ðŸ“‹ 4. ã™ã¹ã¦ã®Workerã‚’è©³ç´°è¡¨ç¤º:"
npx wrangler list --format json 2>/dev/null | jq '.[] | select(.name | contains("component")) | {name: .name, url: .url, zone: .zone}' 2>/dev/null || echo "jqã‚³ãƒžãƒ³ãƒ‰ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“"

echo ""
echo "ðŸ“‹ 5. Workerã®çŠ¶æ…‹ç¢ºèª:"
WORKERS=$(npx wrangler list 2>/dev/null | tail -n +2 | awk '{print $1 " " $2}')

if [ -z "$WORKERS" ]; then
    echo "   âŒ WorkerãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
else
    echo "$WORKERS" | while read -r name url; do
        if [[ "$name" == *"component"* ]]; then
            echo "   ðŸŽ¯ $name: $url"
            
            # URLãŒæœ‰åŠ¹ã‹ãƒ†ã‚¹ãƒˆ
            if [ ! -z "$url" ] && [[ "$url" == https* ]]; then
                echo "      ãƒ†ã‚¹ãƒˆä¸­: $url/api/health"
                HEALTH_CHECK=$(curl -s -w "%{http_code}" "$url/api/health" 2>/dev/null)
                HTTP_CODE="${HEALTH_CHECK: -3}"
                RESPONSE="${HEALTH_CHECK%???}"
                
                if [ "$HTTP_CODE" = "200" ]; then
                    echo "      âœ… APIæ­£å¸¸å‹•ä½œ (HTTP $HTTP_CODE)"
                    echo "      ãƒ¬ã‚¹ãƒãƒ³ã‚¹: $RESPONSE" | head -c 100
                else
                    echo "      âŒ APIç•°å¸¸ (HTTP $HTTP_CODE)"
                fi
            else
                echo "      âš ï¸  ç„¡åŠ¹ãªURL: $url"
            fi
        fi
    done
fi

echo ""
echo "ðŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
echo "   1. ä¸Šè¨˜ã§component-apiã®Workerã¨URLã‚’ç¢ºèªã—ã¦ãã ã•ã„"
echo "   2. æ­£ã—ã„URLãŒè¦‹ã¤ã‹ã£ãŸã‚‰ã€ä»¥ä¸‹ã®ã‚³ãƒžãƒ³ãƒ‰ã§ç’°å¢ƒå¤‰æ•°ã‚’æ‰‹å‹•è¨­å®š:"
echo "      echo 'VITE_API_URL=https://your-actual-worker.workers.dev' > '../component management/.env.local'"
echo "      echo 'VITE_DEV_USE_REMOTE=true' >> '../component management/.env.local'"
echo "      echo 'VITE_ENVIRONMENT=production' >> '../component management/.env.local'"
echo "      echo 'NODE_ENV=development' >> '../component management/.env.local'"
