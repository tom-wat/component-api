#!/bin/bash

echo "ðŸ”§ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç’°å¢ƒå¤‰æ•°æ›´æ–°ã‚¹ã‚¯ãƒªãƒ—ãƒˆ"
echo "================================="

# Workerã®URLã‚’å–å¾—
WORKER_URL=$(npx wrangler list 2>/dev/null | grep "component-api" | awk '{print $2}' | head -1)

if [ -z "$WORKER_URL" ]; then
    echo "âŒ ã‚¨ãƒ©ãƒ¼: component-api WorkerãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    echo "   å…ˆã«component-apiã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãã ã•ã„: ./deploy.sh"
    exit 1
fi

echo "ðŸŒ æ¤œå‡ºã•ã‚ŒãŸWorker URL: $WORKER_URL"

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ‘ã‚¹
FRONTEND_DIR="../component management"
ENV_FILE="$FRONTEND_DIR/.env.local"

if [ ! -d "$FRONTEND_DIR" ]; then
    echo "âŒ ã‚¨ãƒ©ãƒ¼: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $FRONTEND_DIR"
    exit 1
fi

# ç¾åœ¨ã®.env.localãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
if [ -f "$ENV_FILE" ]; then
    cp "$ENV_FILE" "$ENV_FILE.backup"
    echo "ðŸ“‹ æ—¢å­˜ã®.env.localã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ: $ENV_FILE.backup"
fi

# æ–°ã—ã„.env.localãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
cat > "$ENV_FILE" << EOF
# API Base URL - Cloudflare Workers
VITE_API_URL=$WORKER_URL

# é–‹ç™ºç’°å¢ƒã§ãƒªãƒ¢ãƒ¼ãƒˆAPIã‚’ä½¿ç”¨ã™ã‚‹
VITE_DEV_USE_REMOTE=true

# Environment
VITE_ENVIRONMENT=production
NODE_ENV=development
EOF

echo "âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ç’°å¢ƒå¤‰æ•°ã‚’æ›´æ–°ã—ã¾ã—ãŸ"
echo ""
echo "ðŸ“ æ›´æ–°å†…å®¹:"
echo "   VITE_API_URL=$WORKER_URL"
echo "   VITE_DEV_USE_REMOTE=true"
echo "   VITE_ENVIRONMENT=production"
echo ""
echo "ðŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
echo "   1. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•:"
echo "      cd '$FRONTEND_DIR'"
echo "   2. é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•:"
echo "      npm run dev"
echo "   3. ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ä½œç¢ºèª:"
echo "      http://localhost:3000/"
echo "      http://localhost:3000/debug  (APIæŽ¥ç¶šè¨ºæ–­)"
echo "      http://localhost:3000/admin  (ç®¡ç†è€…ãƒšãƒ¼ã‚¸)"
